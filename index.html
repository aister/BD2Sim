<style>
  body {
    margin: 0;
    background: #202020
  }
  .main {
    display: flex
  }
  .side {
    width: 40%;
    padding: 10px;
    height: calc(100vh - 20px);
  }
  .title {
    font-size: 30px;
    margin: 10px;
  }
  select {
    margin-bottom: 5px;
    width: 30%;
    padding: 5px;
  }
  .range {
    display: flex;
    width: 100%;
  }
  .unit {
    width: 25%;
  }
  .thumb {
    padding: 10px;
    text-align: center;
  }
  .thumb img {
    width: 80%;
    margin: 5px;
  }
  .resultContainer {
    display: flex;
    align-items: baseline;
  }
  input {
    width: calc(100% - 10px);
    margin: 5px;
    padding: 5px;
  }
  input.smol {
    width: calc(50% - 5px);
    margin-right: 0;
  }
  .result {
    flex-grow: 1;
    padding: 5px;
    margin-right: 5px;
    background: #ff7600;
    display: none;
    color: black;
  }
  .result.show {
    display: block;
  }
  .rightmost {
    width: 20%;
    color: white;
    padding: 10px;
  }
  a {
    color: #ff7600;
    text-decoration: none;
    font-weight: bold;
  }
  #log {
    resize: none;
    width: 100%;
    height: 300px;
    background: black;
    color: white;
    margin-top: 1em
  }
  button {
    width: 90%;
    padding: 10px;
    margin: 30px auto;
    display: block;
  }
</style>
<div class="main">
  <div class="side" style="background: #4c4c4c; color: white">
    <div class="title">Attacker</div>
    <select>
      <option value="1">Infantry</option>
      <option value="2">Vehicle</option>
      <option value="3">Tank</option>
    </select>
    <div class="range">
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/111.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/112.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/113.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb">Cobra</div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
    </div>
    <div class="range">
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/121.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/122.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/123.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
    </div>
    <div class="range">
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/131.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/132.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i0" src="./imgs/133.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="side" style="background: #dddddd">
    <div class="title">Defender</div>
    <select>
      <option value="1">Infantry</option>
      <option value="2">Vehicle</option>
      <option value="3">Tank</option>
    </select>
    <div class="range">
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/111.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/112.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/113.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb">Cobra</div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
    </div>
    <div class="range">
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/121.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/122.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/123.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
    </div>
    <div class="range">
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/131.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/132.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
      <div class="unit">
        <div class="thumb"><img class="i1" src="./imgs/133.png"></div>
        <div class="resultContainer">
          <input type="number">
          <div class="result"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="rightmost">
    <div class="title" style="text-align: center">BattleDawn 2<br>Battle Sim</div>
    <p>A very limited and somewhat inaccurate battle sim made by Aister</p>
    <p><a href="./faq.html">FAQ</a></p>
    <p><a href="./faq.html#contact">Contact me</a></p>
    <textarea disabled id="log"></textarea>
    <button onclick="start()">Start</button>
  </div>
</div>
<script>
  let chassis = document.querySelectorAll("select");
  let results = document.querySelectorAll(".result");
  chassis.forEach((i, index) => {
    i.onchange = function() {
      document.querySelectorAll(`.i${index}`).forEach(img => {
        img.src = img.src.slice(0, -7) + i.value + img.src.slice(-6);
      })
    }
  })
  function start() {
    let input = document.querySelectorAll('input');
    let log = document.getElementById("log");
    log.value = "";

    let tempAtk = [];
    let tempDef = [];
    let atk = [[parseInt(chassis[0].value), parseInt(input[3].value) || 0]];
    let def = [[parseInt(chassis[1].value), parseInt(input[13].value) || 0]];
    for (i = 0; i <= 9; i++) {
      if (i != 3) {
        tempAtk.push(parseInt(input[i].value) || 0);
        tempDef.push(parseInt(input[i + 10].value) || 0);
        if (i == 2 || i == 6 || i == 9) {
          atk.push(tempAtk);
          tempAtk = [];
          def.push(tempDef);
          tempDef = [];
        }
      }
    }
    const baseHP = [ 8, 6, 4 ];
    const baseDMG = [ 2, 7, 4 ];

    function weapon(full, half, quarter) {
      return full + half * 0.5 + quarter * 0.25;
    }
    function calc(target, shooter, round) {
      target = JSON.parse(JSON.stringify(target));
      let atkDMG = 0;
      if (round > 3) round = 3;
      for (i = 3; i >= 4 - round; i--) {
        let cur = shooter[i];
        if (target[0][0] == 1) atkDMG += weapon(cur[0], cur[1], cur[2]) * baseDMG[i - 1] * shooter[0][0];
        else if (target[0][0] == 2) atkDMG += weapon(cur[1], cur[2], cur[0]) * baseDMG[i - 1] * shooter[0][0] * (shooter[0][0] == 1 ? 1.25 : 1);
        else if (target[0][0] == 3) atkDMG += weapon(cur[2], cur[0], cur[1]) * baseDMG[i - 1] * shooter[0][0] * (shooter[0][0] == 2 ? 1.25 : 1);
      }
      let w = 0;
      let r = 1;
      while (atkDMG > 0) {
        if (target[r][w]) {
          atkDMG -= target[r][w] * baseHP[r - 1] * target[0][0];
          if (atkDMG >= 0) target[r][w] = 0;
          else target[r][w] = - Math.ceil(atkDMG / baseHP[r - 1] / target[0][0]);
          if (round > 1) {
            target[r][w] += target[0][1];
            round == 0;
          }
        }
        w++;
        if (w > 2) {
          r++;
          w = 0;
          if (r > 3) {
            atkDMG = 0;

          }
        }
      }
      return target;
    }
    function checkDead(check) {
      let count = 0;
      for (i = 1; i <= 3; i++) {
        for (ii = 0; ii < 3; ii++) {
          count += check[i][ii];
        }
      }
      return count;
    }

    tempAtk = atk;
    tempDef = def;
    let r = 1;
    while (checkDead(tempAtk) && checkDead(tempDef)) {
      console.log(checkDead(tempAtk), checkDead(tempDef))
      tempAtk = calc(atk, def, r);
      tempDef = calc(def, atk, r);
      def = tempDef || [
        [def[0][0], 0],
        [0, 0, 0],
        [0, 0, 0],
        [0, 0, 0]
      ];
      atk = tempAtk || [
        [atk[0][0], 0],
        [0, 0, 0],
        [0, 0, 0],
        [0, 0, 0]
      ];

      log.value += `
Round ${r}:
${atk[1]}
${atk[2]}
${atk[3]}
======================
${def[1]}
${def[2]}
${def[3]}
`
      
      r++;
    }
    log.value = log.value.slice(0, -1)
    for (i = 0; i <= 9; i++) {
      input[i].classList.add("smol");
      input[i + 10].classList.add("smol");
      results[i].classList.add("show");
      results[i + 10].classList.add("show");
      if (i < 3) {
        results[i].innerHTML = atk[1][i];
        results[i + 10].innerHTML = def[1][i];
      } else if (i == 3) {
        results[i].innerHTML = atk[0][1];
        results[i + 10].innerHTML = def[0][1];
      } else if (i < 7) {
        results[i].innerHTML = atk[2][i - 4];
        results[i + 10].innerHTML = def[2][i - 4];
      } else {
        results[i].innerHTML = atk[3][i - 7];
        results[i + 10].innerHTML = def[3][i - 7];
      }
    }
  }
</script>